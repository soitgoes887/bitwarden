FROM alpine:latest

# Install required packages
RUN apk add --no-cache \
    aws-cli \
    sqlite \
    tzdata \
    bash

# Set timezone (change as needed)
ENV TZ=Europe/London

# Copy backup script
COPY backup.sh /usr/local/bin/backup.sh
RUN chmod +x /usr/local/bin/backup.sh

# Create crontab file
# Default: Run weekly on Monday at 20:30 (8:30 PM)
# Use tee to write logs to both file and stdout (for docker logs)
RUN echo "30 20 * * 1 /usr/local/bin/backup.sh 2>&1 | tee -a /var/log/backup.log" > /etc/crontabs/root

# Create log file
RUN touch /var/log/backup.log

# Create backups directory
RUN mkdir -p /backups

# Health check
HEALTHCHECK --interval=1h --timeout=10s --start-period=5s \
    CMD test -f /var/log/backup.log && tail -1 /var/log/backup.log | grep -q "Backup complete" || exit 0

# Run crond in foreground
CMD crond -f -l 2
