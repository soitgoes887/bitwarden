version: '3.8'

services:
  bitwarden:
    image: vaultwarden/server:latest
    container_name: bitwarden
    restart: unless-stopped
    environment:
      # Server Configuration
      DOMAIN: ${DOMAIN:-https://vault.example.com}
      SIGNUPS_ALLOWED: ${SIGNUPS_ALLOWED:-true}
      INVITATIONS_ALLOWED: ${INVITATIONS_ALLOWED:-true}
      SHOW_PASSWORD_HINT: ${SHOW_PASSWORD_HINT:-false}

      # Admin Panel
      ADMIN_TOKEN: ${ADMIN_TOKEN}

      # Database (optional - uses SQLite by default)
      # DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}

      # SMTP Configuration (optional - uncomment all lines below to enable email)
      # SMTP_HOST: ${SMTP_HOST}
      # SMTP_FROM: ${SMTP_FROM}
      # SMTP_PORT: ${SMTP_PORT:-587}
      # SMTP_SECURITY: ${SMTP_SECURITY:-starttls}
      # SMTP_USERNAME: ${SMTP_USERNAME}
      # SMTP_PASSWORD: ${SMTP_PASSWORD}

      # Security
      WEBSOCKET_ENABLED: ${WEBSOCKET_ENABLED:-true}
      WEBSOCKET_ADDRESS: 0.0.0.0
      WEBSOCKET_PORT: 3012
      WEB_VAULT_ENABLED: ${WEB_VAULT_ENABLED:-true}

    volumes:
      - ./bw-data:/data
    # Ports exposed only to Caddy (not to host)
    # Remove port mappings when using Caddy reverse proxy
    expose:
      - "80"
      - "3012"
    networks:
      - bitwarden-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: PostgreSQL Database
  # Uncomment if you want to use PostgreSQL instead of SQLite
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: bitwarden-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-bitwarden}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD}
  #     POSTGRES_DB: ${DB_NAME:-bitwarden}
  #   volumes:
  #     - ./postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - bitwarden-network

  # Caddy reverse proxy with automatic HTTPS
  # Handles SSL certificates automatically via Let's Encrypt
  caddy:
    image: caddy:latest
    container_name: bitwarden-caddy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy-data:/data
      - ./caddy-config:/config
    networks:
      - bitwarden-network
    depends_on:
      - bitwarden
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Automated backup service
  # Runs weekly backups and uploads to S3
  backup:
    build:
      context: .
      dockerfile: Dockerfile.backup
    container_name: bitwarden-backup
    restart: unless-stopped
    environment:
      # AWS S3 Configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-eu-west-2}
      S3_BUCKET: ${S3_BUCKET}
      S3_PREFIX: ${S3_PREFIX:-bitwarden/}

      # Optional: Custom S3 endpoint (for S3-compatible services like Wasabi, MinIO)
      AWS_ENDPOINT: ${AWS_ENDPOINT}

      # Backup retention
      KEEP_LOCAL_BACKUPS: ${KEEP_LOCAL_BACKUPS:-3}
      DELETE_LOCAL_AFTER_UPLOAD: ${DELETE_LOCAL_AFTER_UPLOAD:-false}

      # Healthchecks.io monitoring
      HEALTHCHECK_URL: ${HEALTHCHECK_URL:-https://hc-ping.com/899194da-c3ed-4ff0-b672-2fc7aaa3cfe9}

      # Timezone
      TZ: ${TZ:-Europe/London}
    volumes:
      - ./bw-data:/data:ro
      - ./backups:/backups
    networks:
      - bitwarden-network
    depends_on:
      - bitwarden
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Health monitoring service
  # Checks all services and reports to healthchecks.io
  healthcheck:
    build:
      context: .
      dockerfile: Dockerfile.healthcheck
    container_name: bitwarden-healthcheck
    restart: unless-stopped
    environment:
      # Healthchecks.io monitoring URL
      HEALTHCHECK_URL: ${SYSTEM_HEALTHCHECK_URL:-https://hc-ping.com/e3747dbd-9bae-40bb-b334-73252b9e3730}

      # Timezone
      TZ: ${TZ:-Europe/London}
    networks:
      - bitwarden-network
    depends_on:
      - bitwarden
      - caddy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  bitwarden-network:
    driver: bridge

volumes:
  bw-data:
