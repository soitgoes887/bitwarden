version: '3.8'

services:
  bitwarden:
    image: vaultwarden/server:latest
    container_name: bitwarden
    restart: unless-stopped
    environment:
      # Server Configuration
      DOMAIN: ${DOMAIN:-https://vault.example.com}
      SIGNUPS_ALLOWED: ${SIGNUPS_ALLOWED:-true}
      INVITATIONS_ALLOWED: ${INVITATIONS_ALLOWED:-true}
      SHOW_PASSWORD_HINT: ${SHOW_PASSWORD_HINT:-false}

      # Admin Panel
      ADMIN_TOKEN: ${ADMIN_TOKEN}

      # Database (optional - uses SQLite by default)
      # DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}

      # SMTP Configuration (optional - uncomment all lines below to enable email)
      # SMTP_HOST: ${SMTP_HOST}
      # SMTP_FROM: ${SMTP_FROM}
      # SMTP_PORT: ${SMTP_PORT:-587}
      # SMTP_SECURITY: ${SMTP_SECURITY:-starttls}
      # SMTP_USERNAME: ${SMTP_USERNAME}
      # SMTP_PASSWORD: ${SMTP_PASSWORD}

      # Security
      WEBSOCKET_ENABLED: ${WEBSOCKET_ENABLED:-true}
      WEB_VAULT_ENABLED: ${WEB_VAULT_ENABLED:-true}

    volumes:
      - ./bw-data:/data
    # Ports exposed only to Caddy (not to host)
    # Remove port mappings when using Caddy reverse proxy
    expose:
      - "80"
      - "3012"
    networks:
      - bitwarden-network

  # Optional: PostgreSQL Database
  # Uncomment if you want to use PostgreSQL instead of SQLite
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: bitwarden-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-bitwarden}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD}
  #     POSTGRES_DB: ${DB_NAME:-bitwarden}
  #   volumes:
  #     - ./postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - bitwarden-network

  # Caddy reverse proxy with automatic HTTPS
  # Handles SSL certificates automatically via Let's Encrypt
  caddy:
    image: caddy:latest
    container_name: bitwarden-caddy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy-data:/data
      - ./caddy-config:/config
    networks:
      - bitwarden-network
    depends_on:
      - bitwarden

networks:
  bitwarden-network:
    driver: bridge

volumes:
  bw-data:
